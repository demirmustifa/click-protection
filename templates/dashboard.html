<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tıklama Koruma Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #map {
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        .stats-card {
            margin-bottom: 20px;
        }
        .risk-high {
            color: #dc3545;
        }
        .risk-medium {
            color: #ffc107;
        }
        .risk-low {
            color: #28a745;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">Tıklama Koruma Dashboard</h1>
        
        <!-- Harita -->
        <div class="card stats-card">
            <div class="card-header">
                <h5 class="card-title mb-0">Coğrafi Konum Analizi</h5>
            </div>
            <div class="card-body">
                <div id="map"></div>
            </div>
        </div>

        <div class="row">
            <!-- Ülke İstatistikleri -->
            <div class="col-md-6">
                <div class="card stats-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Ülke İstatistikleri</h5>
                    </div>
                    <div class="card-body">
                        <div id="countryStats"></div>
                    </div>
                </div>
            </div>

            <!-- Risk Analizi -->
            <div class="col-md-6">
                <div class="card stats-card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Risk Analizi</h5>
                    </div>
                    <div class="card-body">
                        <div id="riskStats"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Genel İstatistikler -->
        <div class="card stats-card">
            <div class="card-header">
                <h5 class="card-title mb-0">Genel İstatistikler</h5>
            </div>
            <div class="card-body">
                <div id="generalStats"></div>
            </div>
        </div>

        <!-- Raporlar -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Raporlar</h5>
            </div>
            <div class="card-body">
                <a href="/download-excel" class="btn btn-primary me-2">Excel Raporu İndir</a>
                <a href="/download-pdf" class="btn btn-secondary">PDF Raporu İndir</a>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Harita başlatma
        var map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Marker grupları
        var markers = L.layerGroup().addTo(map);
        var riskMarkers = L.layerGroup().addTo(map);

        function updateMap(locations) {
            markers.clearLayers();
            riskMarkers.clearLayers();

            locations.forEach(loc => {
                if (loc.latitude && loc.longitude) {
                    var color = loc.risk_score > 50 ? 'red' : 'blue';
                    var marker = L.circleMarker([loc.latitude, loc.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });

                    marker.bindPopup(`
                        <b>Ülke:</b> ${loc.country}<br>
                        <b>Şehir:</b> ${loc.city}<br>
                        <b>Risk Skoru:</b> ${loc.risk_score}
                    `);

                    if (loc.risk_score > 50) {
                        riskMarkers.addLayer(marker);
                    } else {
                        markers.addLayer(marker);
                    }
                }
            });
        }

        function updateCountryStats(stats) {
            const countryStatsDiv = document.getElementById('countryStats');
            let html = '<div class="table-responsive"><table class="table">';
            html += '<thead><tr><th>Ülke</th><th>Tıklama Sayısı</th></tr></thead><tbody>';
            
            Object.entries(stats)
                .sort((a, b) => b[1] - a[1])
                .forEach(([country, count]) => {
                    html += `<tr><td>${country}</td><td>${count}</td></tr>`;
                });
            
            html += '</tbody></table></div>';
            countryStatsDiv.innerHTML = html;
        }

        function updateRiskStats(locations) {
            const riskStatsDiv = document.getElementById('riskStats');
            const highRisk = locations.filter(loc => loc.risk_score > 50).length;
            const mediumRisk = locations.filter(loc => loc.risk_score > 30 && loc.risk_score <= 50).length;
            const lowRisk = locations.filter(loc => loc.risk_score <= 30).length;

            riskStatsDiv.innerHTML = `
                <div class="mb-3">
                    <div class="risk-high">Yüksek Risk: ${highRisk}</div>
                    <div class="risk-medium">Orta Risk: ${mediumRisk}</div>
                    <div class="risk-low">Düşük Risk: ${lowRisk}</div>
                </div>
            `;
        }

        function fetchLocationStats() {
            fetch('/api/location-stats')
                .then(response => response.json())
                .then(data => {
                    updateMap(data.recent_locations);
                    updateCountryStats(data.country_stats);
                    updateRiskStats(data.recent_locations);
                });
        }

        // Her 30 saniyede bir güncelle
        fetchLocationStats();
        setInterval(fetchLocationStats, 30000);
    </script>
</body>
</html> 
</html> 